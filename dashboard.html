{% extends "base.html" %}

{% block title %}Abokin | IA Dashboard{% endblock %}

{% block content %}
<canvas id="starfield"></canvas>

<div class="dashboard-header futuristic-header">
    <h1 class="glow-title">Bienvenido, {{ name }}!</h1>
    <p class="meta-data">Identificador: <strong>{{ username }}</strong></p>
    <div class="logout-link">
        <a href="{{ url_for('logout') }}" class="nav-link futuristic-link">‚èª Cerrar Sesi√≥n</a>
    </div>
</div>

<div class="dashboard-content futuristic-panel">
    <div class="chat-container">
        <h3 class="section-title">Asistente Inteligente Abokin</h3>
        <div id="chat-box" class="chat-box">
            <div class="bot-message">üí¨ Hola, soy tu asistente IA. ¬øQu√© misi√≥n deseas ejecutar?</div>
        </div>

        <form id="chat-form" onsubmit="sendMessage(event)">
            <input type="text" id="user-input" placeholder="Escribe tu mensaje..." required>
            <button type="submit">Enviar</button>
        </form>
    </div>

    <hr class="divider">

    <h2 class="section-title">Panel de Control</h2>
    <p class="section-desc">Zona de operaciones protegida por IA de seguridad.</p>

    <div class="demo-info">
        <h3 class="info-title">Tecnolog√≠as Activas:</h3>
        <ul>
            <li>Autenticaci√≥n reforzada (<code>@login_required</code>)</li>
            <li>Lectura activa de <code>current_user</code></li>
            <li>Sistema de mensajes IA (Flash Feedback)</li>
            <li>Blindaje CSRF en formularios</li>
        </ul>
    </div>

    <hr class="divider">

    <div class="cart-links">
        <a href="{{ url_for('plans') }}" class="nav-link futuristic-link">Ver Planes</a>
        <a href="{{ url_for('cart') }}" class="nav-link futuristic-link">Carrito</a>
    </div>
</div>

<style>
    body {
        margin: 0;
        font-family: 'Orbitron', sans-serif;
        background: black;
        color: #fff;
        overflow-x: hidden;
    }

    #starfield {
        position: fixed;
        top: 0;
        left: 0;
        z-index: -1;
        width: 100%;
        height: 100%;
        background: black;
    }

    .dashboard-header {
        padding: 2rem;
        text-align: center;
        position: relative;
    }

    .glow-title {
        font-size: 2.5rem;
        color: #0ff;
        text-shadow: 0 0 15px #0ff, 0 0 25px #0ff;
        margin-bottom: 0.5rem;
    }

    .meta-data {
        font-size: 1rem;
        color: #ccc;
    }

    .logout-link {
        position: absolute;
        top: 1rem;
        right: 2rem;
    }

    .nav-link.futuristic-link {
        color: #0ff;
        font-weight: bold;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border: 1px solid #0ff;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .nav-link.futuristic-link:hover {
        background: #0ff;
        color: #000;
    }

    .dashboard-content {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 16px;
        box-shadow: 0 0 25px rgba(0, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }

    .chat-container {
        margin-bottom: 2rem;
        background: rgba(0, 0, 0, 0.4);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #0ff;
    }

    .chat-box {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 10px;
        background: #111;
        border: 1px solid #0ff;
        border-radius: 8px;
    }

    .bot-message, .user-message {
        margin-bottom: 8px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
        font-size: 0.9rem;
    }

    .bot-message {
        background: #0ff2;
        color: #0ff;
        align-self: flex-start;
    }

    .user-message {
        background: #0f02;
        color: #0f0;
        text-align: right;
        margin-left: auto;
    }

    #chat-form {
        display: flex;
        gap: 10px;
    }

    #user-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #0ff;
        border-radius: 8px;
        background: #000;
        color: #0ff;
    }

    button {
        padding: 10px 15px;
        background: #0ff;
        border: none;
        color: #000;
        border-radius: 8px;
        cursor: pointer;
    }

    button:hover {
        background: #0cf;
    }

    .section-title {
        color: #0ff;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .section-desc {
        color: #aaa;
        margin-bottom: 1.5rem;
    }

    .info-title {
        color: #0ff;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
    }

    .divider {
        margin: 2rem 0;
        border: none;
        border-top: 1px solid #0ff5;
    }

    ul {
        list-style: square;
        padding-left: 1.5rem;
    }

    li {
        margin-bottom: 0.5rem;
    }

    .cart-links {
        display: flex;
        justify-content: space-around;
        margin-top: 2rem;
    }
</style>

<script>
    // Fondo de estrellas
    const canvas = document.getElementById("starfield");
    const ctx = canvas.getContext("2d");
    let stars = [];
    const numStars = 200;

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function createStars() {
        stars = [];
        for (let i = 0; i < numStars; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 1.5,
                speed: Math.random() * 0.5 + 0.2
            });
        }
    }

    function drawStars() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#ffffff";
        stars.forEach(star => {
            ctx.beginPath();
            ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function updateStars() {
        stars.forEach(star => {
            star.y += star.speed;
            if (star.y > canvas.height) {
                star.y = 0;
                star.x = Math.random() * canvas.width;
            }
        });
    }

    function animate() {
        drawStars();
        updateStars();
        requestAnimationFrame(animate);
    }

    createStars();
    animate();

    // L√≥gica de chat
    async function sendMessage(event) {
        event.preventDefault();

        const input = document.getElementById('user-input');
        const message = input.value.trim();
        if (!message) return;

        const chatBox = document.getElementById('chat-box');

        const userMsg = document.createElement('div');
        userMsg.className = 'user-message';
        userMsg.innerText = message;
        chatBox.appendChild(userMsg);
        input.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            });

            const data = await res.json();
            const botMsg = document.createElement('div');
            botMsg.className = 'bot-message';
            botMsg.innerText = data.response;
            chatBox.appendChild(botMsg);
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (err) {
            console.error('Error:', err);
        }
    }
</script>
{% endblock %}